name: 'Maven Tests'
description: 'Runs maven build on the targeted project'
inputs:
  GH_USERNAME:
    required: true
  GH_TOKEN:
    required: true
  MAVEN_REPO:
    required: false
    default: '.m2/repository'
  MAVEN_CLI_OPTS:
    required: false
    default: '-s .m2/settings.xml'
  MAVEN_OPTS:
    required: false
    default: '-Dmaven.repo.local=.m2/repository'
  RELEASE_VERSION:
    required: true
  DEVELOPMENT_VERSION:
    required: true
  DOCKER_USERNAME:
    required: true
  DOCKER_PASSWORD:
    required: true

runs:
  using: 'composite'
  steps:
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ${{ inputs.MAVEN_REPO }}
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Configure Git user
      shell: bash
      run: |
        git config user.email "icarodamiani@gmail.com.com"
        git config user.name "icarodamiani"

    - name: Build
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GH_TOKEN }}
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}
      run: |
        ./mvnw ${{ inputs.MAVEN_CLI_OPTS }} ${{ inputs.MAVEN_OPTS }} clean install -U -P dev

    - name: Publish JAR
      shell: bash
      run: ./mvnw ${{ inputs.MAVEN_CLI_OPTS }} ${{ inputs.MAVEN_OPTS }} release:prepare release:perform
      env:
        GITHUB_TOKEN: ${{ inputs.GH_TOKEN }}
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}

    - name: "Deploy Release"
      shell: bash
      env:
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}
      run: |
        ./mvnw $MAVEN_CLI_OPTS $MAVEN_OPTS release:perform

    - name: Archive Production Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jar
        path: target/*.jar

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.DOCKER_USERNAME }}
        password: ${{ inputs.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      id: push
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: true