name: 'Maven Tests'
description: 'Runs maven build on the targeted project'
inputs:
  GH_USERNAME:
    required: true
  GH_TOKEN:
    required: true
  MAVEN_REPO:
    required: false
    default: '.m2/repository'
  MAVEN_CLI_OPTS:
    required: false
    default: '-s .m2/settings.xml'
  MAVEN_OPTS:
    required: false
    default: '-Dmaven.repo.local=.m2/repository'
  PROJECT:
    required: true

runs:
  using: 'composite'
  steps:
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ${{ inputs.MAVEN_REPO }}
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GH_TOKEN }}
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}
      run: |
        ./mvnw ${{ inputs.MAVEN_CLI_OPTS }} ${{ inputs.MAVEN_OPTS }} clean install -pl ${{ PROJECT }} -U -P dev

    - name: Publish JAR
      shell: bash
      run: ./mvnw ${{ inputs.MAVEN_CLI_OPTS }} ${{ inputs.MAVEN_OPTS }} release:prepare release:perform -pl ${{ PROJECT }}
      env:
        GITHUB_TOKEN: ${{ inputs.GH_TOKEN }}
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}

    - name: "Deploy Release"
      shell: bash
      env:
        GH_USERNAME: ${{ inputs.GH_USERNAME }}
        GH_TOKEN: ${{ inputs.GH_TOKEN }}
      run: |
        ./mvnw $MAVEN_CLI_OPTS $MAVEN_OPTS release:perform -pl ${{ PROJECT }}

    - name: Archive Production Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jar
        path: target/*.jar